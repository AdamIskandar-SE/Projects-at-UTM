<html>
<head>
    <title>TTMS - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <style>
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }
        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="w3-container login-container">
        <h2 class="w3-center w3-text-blue">FC Timetable System</h2>
        <div class="w3-panel w3-pale-blue">
            <p>Please login with your UTM credentials</p>
        </div>
        
        <div id="loginForm">
            <label class="w3-text-blue"><b>Username</b></label>
            <input class="w3-input w3-border" type="text" id="login" value="A16CS4016">
            
            <label class="w3-text-blue"><b>Password</b></label>
            <input class="w3-input w3-border" type="password" id="password" value="201608M10112">
            
            <div class="w3-panel w3-pale-red error-message" id="errorMsg">
                Invalid credentials. Please try again.
            </div>
            
            <div class="w3-center w3-margin-top">
                <button class="w3-btn w3-blue" id="btnLogin">Login</button>
                <div class="w3-padding w3-center loading" id="loading">
                    <div class="w3-border w3-round w3-border-blue" style="width: 100%">
                        <div class="w3-blue" style="height:24px;width:100%" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // Check if already logged in
        if (localStorage.getItem("web.fc.utm.my_userSession")) {
            window.location.replace("ttms-main-mobile.html");
        }
        
        $("#btnLogin").click(function() {
            const username = $("#login").val().trim();
            const password = $("#password").val().trim();
            
            // Basic validation
            if (!username || !password) {
                $("#errorMsg").text("Please enter both username and password");
                $("#errorMsg").show();
                return;
            }
            
            // Show loading animation
            $("#btnLogin").prop("disabled", true);
            $("#loading").show();
            
            // API endpoint
            const url = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=authentication&login=" + 
                         encodeURIComponent(username) + "&password=" + encodeURIComponent(password);
            
            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        throw new Error("Login failed");
                    }
                    return res.json();
                })
                .then(jsonInst => { 
                    if (jsonInst && jsonInst.length > 0) {
                        // Store user session
                        localStorage.setItem("web.fc.utm.my_userSession", JSON.stringify(jsonInst[0]));
                        
                        // Get session-semester data before redirecting
                        return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
                            .then(res => res.json())
                            .then(sessemData => {
                                localStorage.setItem("web.fc.utm.my_sessemList", JSON.stringify(sessemData));
                                localStorage.setItem("web.fc.utm.my_sessemCurr", JSON.stringify(sessemData[0]));
                                return true;
                            });
                    } else {
                        throw new Error("Invalid login response");
                    }
                })
                .then(() => {
                    window.location.replace("ttms-main-mobile.html");
                })
                .catch(err => {
                    console.error(err);
                    $("#errorMsg").text("Login failed: " + err.message);
                    $("#errorMsg").show();
                    $("#btnLogin").prop("disabled", false);
                    $("#loading").hide();
                });
        });
        
        // Allow login with Enter key
        $("#password").keypress(function(e) {
            if (e.which === 13) {
                $("#btnLogin").click();
            }
        });
    });
</script>